---
title: "Simulación"
author: "Yanink Neried Caro Vega y Lizbeth Naranjo Albarrán"
date: "Proyecto I: Métodos Estadísticos para la Investigación  en VIH/SIDA"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Increased Mortality After Tuberculosis Treatment Completion in Persons Living With Human Immunodeficiency Virus in Latin America 

**We assessed the association between cured tuberculosis (TB) and mortality among persons living with human immunodeficiency virus (HIV) in Latin America. We compared survival among persons with and without TB at enrollment in HIV care, starting 9 months after clinic enrollment. In multivariable analysis, TB was associated with higher long-term mortality (hazard ratio, 1.57; 95% confidence interval, 1.25–1.99).** 

## Usando base de datos CCASAnet

Usar datos de CCASAnet:

```{r, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(ggplot2)
library(car)
library(dplyr)

setwd("~/Documents/_NotasCiencias/ProyectoVIH/Proyecto06_Simulacion/CCASAnet_Data/mock-ccasanet-data-2017-01-19/")
dir <- "~/Documents/_NotasCiencias/ProyectoVIH/Proyecto06_Simulacion/CCASAnet_Data/mock-ccasanet-data-2017-01-19/"
```

```{r}
art <- read.csv(paste0(dir,"art_sim.csv"))
basic <- read.csv(paste0(dir,"basic_sim.csv"))
follow <- read.csv(paste0(dir,"follow_sim.csv"))
lab_cd4 <- read.csv(paste0(dir,"lab_cd4_sim.csv"))
lab_rna <- read.csv(paste0(dir,"lab_rna_sim.csv"))
visit <- read.csv(paste0(dir,"visit_sim.csv"))
## #dim(art); #dim(basic); #dim(follow); #dim(lab_cd4); #dim(lab_rna); #dim(visit)
head(art,3)
head(basic,3)
head(follow,3)
head(lab_cd4,3)
head(lab_rna,3)
head(visit,3)
```

Cambiar formato de las fechas. 

```{r}
class(basic$birth_d)
basic$birth_d <- as.Date(basic$birth_d,"%Y-%m-%d")
class(basic$birth_d)
basic$baseline_d <- as.Date(basic$baseline_d,"%Y-%m-%d")
follow$death_d <- as.Date(follow$death_d,"%Y-%m-%d")
follow$l_alive_d <- as.Date(follow$l_alive_d,"%Y-%m-%d")
lab_cd4$cd4_d <- as.Date(lab_cd4$cd4_d,"%Y-%m-%d")
```

Simular otras variables necesarias: 

```{r}
lab_cd4$cd4_v_m227 = ifelse(lab_cd4$cd4_v<227,1,0)
basic$education = sample(c(1,0),size=nrow(basic),replace=TRUE,prob=c(0.15,85)) ### patients (15%) had no education or primary school only
basic$age_M35 = ifelse(basic$age>35,1,0)
```

Unir tablas, usando variables en común "patient" y "site":

```{r}
datos_bf <- merge(basic,follow, by=c("patient","site"),all=TRUE) 
lab_cd4_base <- subset(lab_cd4,lab_cd4$time==0) ### CD4 baseline
datos_bf4 <- merge(datos_bf,lab_cd4_base, by=c("patient","site"), all.x=FALSE,all.y=FALSE,nu.dups=TRUE)
```

Generar una tabla para enfermedad: 

```{r}
diseases = data.frame(patient=basic$patient, site=basic$site) 
diseases$tuberculosis_y = 0
diseases$tuberculosis_d = as.Date(NA)
patients = unique(lab_cd4$patient) ### pacientes con laboratorio CD4
Ntb = n_distinct(patients)

tuberculosis = sample(c(1,0),size=Ntb,replace=TRUE,prob=c(6.8,93.2))

# Ntb_a = n_distinct(follow$patient[follow$death_y==0])
# Ntb_d = n_distinct(follow$patient[follow$death_y==1])
# prob_a = -log(0.932)/log(1.57) 
# prob_d = -log(0.068)/log(1.57)
# tb_alive = sample(c(1,0),size=Ntb_a,replace=TRUE,prob=c(6.8,93.2))
# tb_death = sample(c(1,0),size=Ntb_d,replace=TRUE,prob=c(6.8,93.2))
# tuberculosis = sample(c(1,0),size=Ntb,replace=TRUE,prob=c(6.8,93.2))
```

Simular la fecha en la que se diagnostica, tomando como base las fechas de CD4: 

```{r}
for(i in 1:Ntb){
  if(tuberculosis[i]==1){
    id = patients[i] 
    datos_id = subset(lab_cd4,lab_cd4$patient==id)
    id.num = which(diseases$patient==as.character(id)) 
    diseases$tuberculosis_y[id.num] = 1
    diseases$tuberculosis_d[id.num] = sample(datos_id$cd4_d,size=1)
  }
}
head(diseases)
datos_bf4d <- merge(datos_bf4,diseases, by=c("patient","site"), all.x=FALSE,all.y=FALSE,nu.dups=TRUE)
```

## Estimar modelo de Cox usando tabla "follow"

```{r, warning=FALSE,message=FALSE, fig.show = "hold", out.width = "50%"} 
library(survival)
datos_bf4d$tiempo = ifelse(datos_bf4d$death_y==1,
                           as.numeric(difftime(datos_bf4d$death_d,datos_bf4d$birth_d, units="auto"))/365.25,
                           as.numeric(difftime(datos_bf4d$l_alive_d,datos_bf4d$birth_d, units="auto"))/365.25)
  
datos_bf4d$muerte = datos_bf4d$death_y
```

Modelo de Cox: 

```{r, warning=FALSE,message=FALSE, fig.show = "hold", out.width = "50%"} 
mod_cox <- coxph(Surv(tiempo, muerte) ~ tuberculosis_y + cd4_v_m227 + education + age_M35 , data=datos_bf4d)
summary(mod_cox)

km <- survfit(Surv(tiempo, muerte) ~ tuberculosis_y, type = "kaplan-meier",conf.type="log-log", data=datos_bf4d)
plot(km, conf.int=T,xlab="time", ylab="Survival", lty=c(1,4), 
     lwd=2, xlim=c(0,100), col=c("red","red","red","blue","blue","blue"))
legend("topright", c("No Baseline TB","Baseline TB"), lty=c(1,4),col=c("red","blue"))

plot(km, conf.int=T,xlab="time", fun="event", ylab="Probability of Death", lty=c(1,4), 
     lwd=2, xlim=c(0,100), col=c("blue","blue","blue","red","red","red"))
legend("topright", c("No Baseline TB","Baseline TB"), lty=c(1,4),col=c("red","blue")) 

```





## Simular variable respuesta para modelo de Cox 

Valores de los parametros y simulacion del tiempo: 

```{r, warning=FALSE,message=FALSE, fig.show = "hold",out.width = "50%"} 
attach(datos_bf4d)
N = n_distinct(patient)
beta_HR_TB = log(1.57) 
beta_HR_CD4 = log(1.57) 
beta_HR_age = log(1.56) 
beta_HR_edu = log(1.24) 

XBeta =  tuberculosis_y*beta_HR_TB + cd4_v_m227*beta_HR_CD4 + education*beta_HR_edu + age_M35*beta_HR_age 

sigma = 3   ### parametro para weibull
tiempo = rweibull(n=N, shape=1/sigma, scale=exp(XBeta))

muerte = rep(0,N)
muerte[tuberculosis_y==1] = sample(c(1,0),size=sum(tuberculosis_y==1),replace=TRUE,
                                   prob=c(10.2,89.8))
muerte[tuberculosis_y==0] = sample(c(1,0),size=N-sum(tuberculosis_y==1),replace=TRUE,
                                   prob=c(5.6,94.4))
```

Modelo de Cox:

```{r, warning=FALSE,message=FALSE, fig.show = "hold", out.width = "50%"} 
mod_cox <- coxph(Surv(tiempo, muerte) ~ tuberculosis_y + cd4_v_m227 + education + age_M35 )
summary(mod_cox)
km <- survfit(Surv(tiempo, muerte) ~ tuberculosis_y, type = "kaplan-meier",conf.type="log-log")
plot(km, conf.int=T,xlab="time", ylab="Survival", lty=c(1,4), 
     lwd=2, xlim=c(0,100), col=c("red","red","red","blue","blue","blue"))
legend("topright", c("No Baseline TB","Baseline TB"), lty=c(1,4),col=c("red","blue"))

plot(km, conf.int=T,xlab="time", fun="event", ylab="Probability of Death", lty=c(1,4), 
     lwd=2, xlim=c(0,100), col=c("blue","blue","blue","red","red","red"))
legend("topright", c("No Baseline TB","Baseline TB"), lty=c(1,4),col=c("red","blue")) 

```
